#!/bin/bash

echo -n "Enter the AWS DR Region to use > "
read drregion
echo -n "Enter S3 Bucket to host the templates and scripts > "
read bucket
echo -n "Enter CloudFormation stackname to create > "
read stackname
echo -n "Enter the e-mail address for Pipeline Approval > "
read email

echo ""
echo -n "Building Lambda Deployment Package ..."
echo ""
cp lambda/deps.zip deploy/package.zip
cp lambda/src/*.py deploy/
cd deploy
zip -r package.zip *.py
cd .. 

echo ""
echo -n "Launching DR CloudFormation Package ..."
echo ""
aws cloudformation deploy --stack-name CentralLogging-Bucket --template-file ./templates/central-logging-bucket.yaml --capabilities CAPABILITY_NAMED_IAM --parameter-overrides BucketName=$stackname-central-logging-bucket --region $drregion

echo ""
echo -n "Building Primary CloudFormation Package ..."
echo ""
zip deploy/templates.zip main.yaml templates/*
cd scripts && zip scripts.zip * && cd ..
mv scripts/scripts.zip deploy/scripts.zip

echo ""
echo -n "Uploading CloudFormation Templates to s3 ..."
echo ""
aws s3 mb "s3://${bucket}" --region us-east-1
aws s3 cp deploy/templates.zip "s3://${bucket}" --acl public-read --region us-east-1
aws s3 cp deploy/scripts.zip "s3://${bucket}" --acl public-read --region us-east-1
aws s3 cp deploy/package.zip "s3://${bucket}" --acl public-read --region us-east-1
aws s3 cp main.yaml "s3://${bucket}" --acl public-read --region us-east-1
aws s3 cp --recursive templates/ "s3://${bucket}/templates" --acl public-read --region us-east-1
aws s3 cp --recursive scripts/ "s3://${bucket}/scripts" --acl public-read --region us-east-1
aws s3 cp parameters.json "s3://${bucket}/training_input/" --acl public-read --region us-east-1
aws s3api put-bucket-versioning --bucket "${bucket}" --versioning-configuration Status=Enabled --region us-east-1

echo ""
echo -n "Launching CloudFormation Stack ..."
echo ""
aws cloudformation deploy --stack-name $stackname --template-file main.yaml --capabilities CAPABILITY_NAMED_IAM --parameter-overrides TemplateBucket=$bucket EmailAddress=$email LogBucketName=$stackname-central-logging-bucket --region us-east-1